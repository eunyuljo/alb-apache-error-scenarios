# ALB + Apache Proxy ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤

> ğŸ”§ ALB + Apache í™˜ê²½ì—ì„œ ë°œìƒí•˜ëŠ” 502/504 íƒ€ì„ì•„ì›ƒ ë° DNS í•´ì„ ë¬¸ì œë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ê³  ì§„ë‹¨.
> ALBë¥¼ êµ¬í˜„í•˜ì§€ ì•Šê³  docker-compose ë‚´ nginx ë¡œ ì´ë¥¼ ëŒ€ì²˜í•˜ê³  ì¦ìƒë§Œ í™•ì¸.


### ğŸ¯ í•™ìŠµ ëª©í‘œ

- **íƒ€ì„ì•„ì›ƒ ì²´ì¸ ë¶ˆì¼ì¹˜**ë¡œ ì¸í•œ 502 ì—ëŸ¬ ë°œìƒ ì›ë¦¬
- **DNS í•´ì„ ì‹¤íŒ¨**ê°€ ì¦‰ì‹œ ì‹¤íŒ¨ë¡œ ì´ì–´ì§€ëŠ” ê³¼ì •  
- **DNS í•´ì„ ì§€ì—°**ì´ ê°„í—ì  ë¬¸ì œë¥¼ ë§Œë“œëŠ” ì´ìœ 
- **ì„œë¹„ìŠ¤ ë¶ˆì•ˆì •**ì´ ë¬´ì‘ìœ„ ì‹¤íŒ¨ë¡œ ë‚˜íƒ€ë‚˜ëŠ” í˜„ìƒ

### ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

```
ì¸í„°ë„· â†’ ALB (60ì´ˆ íƒ€ì„ì•„ì›ƒ) â†’ Apache Proxy (25ì´ˆ íƒ€ì„ì•„ì›ƒ) â†’ Backend (30-40ì´ˆ ì‘ë‹µ)
```

## ğŸ§ª ì œê³µë˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤

| ì‹œë‚˜ë¦¬ì˜¤ | ë¬¸ì œ ìœ í˜• | ì˜ˆìƒ ê²°ê³¼ | ì†Œìš” ì‹œê°„ | ì‹¤ì œ ì‚¬ë¡€ |
|----------|----------|----------|----------|----------|
| **timeout** | í”„ë¡ì‹œ íƒ€ì„ì•„ì›ƒ | 25ì´ˆ í›„ 502 | ~60ì´ˆ | ëŠë¦° ë°±ì—”ë“œ ì²˜ë¦¬ |
| **dns-failure** | DNS í•´ì„ ì‹¤íŒ¨ | ì¦‰ì‹œ 502 | ~45ì´ˆ | ì˜ëª»ëœ í˜¸ìŠ¤íŠ¸ëª…/ë„ë©”ì¸ |
| **dns-delay** | DNS í•´ì„ ì§€ì—° | ì´ˆê¸° ì‹¤íŒ¨ â†’ ë‚˜ì¤‘ ì„±ê³µ | ~90ì´ˆ | ì„œë¹„ìŠ¤ ì‹œì‘ ì§€ì—° |
| **dns-intermittent** | ì„œë¹„ìŠ¤ ë¶ˆì•ˆì • | ë¶ˆê·œì¹™í•œ ì„±ê³µ/ì‹¤íŒ¨ | ~75ì´ˆ | ì¬ì‹œì‘, Auto Scaling |

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### ì „ì œ ì¡°ê±´
- Docker & Docker Compose ì„¤ì¹˜
- curl ëª…ë ¹ì–´ ì‚¬ìš© ê°€ëŠ¥
- í¬íŠ¸ 80, 8080, 5000 ì‚¬ìš© ê°€ëŠ¥

### 1. ì €ì¥ì†Œ í´ë¡ 
```bash
git clone https://github.com/eunyuljo/alb-apache-error-scenarios.git
cd alb-apache-error-scenarios
```

### 2. ì „ì²´ ì„¤ì • ë° í…ŒìŠ¤íŠ¸
```bash
# ëª¨ë“  ì„¤ì • íŒŒì¼ ìë™ ìƒì„±
./complete-setup.sh

# ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ìˆœì°¨ ì‹¤í–‰
./run-all-scenarios.sh
```

### 3. ê°œë³„ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
```bash
# ë¹ ë¥¸ ê°œë³„ í…ŒìŠ¤íŠ¸
./quick-test.sh timeout           # íƒ€ì„ì•„ì›ƒ ì‹œë‚˜ë¦¬ì˜¤
./quick-test.sh dns-failure       # DNS ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤
./quick-test.sh dns-delay         # DNS ì§€ì—° ì‹œë‚˜ë¦¬ì˜¤
./quick-test.sh dns-intermittent  # ê°„í—ì  DNS ë¬¸ì œ
```

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
â”œâ”€â”€ common/                           # ê³µí†µ íŒŒì¼
â”‚   â”œâ”€â”€ backend-app.py               # ê³µí†µ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜
â”‚   â””â”€â”€ nginx-alb.conf               # ê³µí†µ ALB ì‹œë®¬ë ˆì´í„° ì„¤ì •
â”œâ”€â”€ scenarios/                       # ì‹œë‚˜ë¦¬ì˜¤ë³„ ì„¤ì •
â”‚   â”œâ”€â”€ timeout/                     # íƒ€ì„ì•„ì›ƒ ì‹œë‚˜ë¦¬ì˜¤
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   â”œâ”€â”€ nginx-timeout.conf
â”‚   â”‚   â””â”€â”€ apache-timeout.conf
â”‚   â”œâ”€â”€ dns-failure/                 # DNS ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   â”œâ”€â”€ nginx-dns-failure.conf
â”‚   â”‚   â””â”€â”€ apache-dns-fail.conf
â”‚   â”œâ”€â”€ dns-delay/                   # DNS ì§€ì—° ì‹œë‚˜ë¦¬ì˜¤
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   â”œâ”€â”€ nginx-dns-delay.conf
â”‚   â”‚   â””â”€â”€ apache-dns-slow.conf
â”‚   â””â”€â”€ dns-intermittent/           # ê°„í—ì  DNS ë¬¸ì œ
â”‚       â”œâ”€â”€ docker-compose.yml
â”‚       â”œâ”€â”€ nginx-dns-intermittent.conf
â”‚       â”œâ”€â”€ apache-dns-intermittent.conf
â”‚       â””â”€â”€ unstable-backend.py
â”œâ”€â”€ complete-setup.sh               # ì „ì²´ ì„¤ì • ìë™ ìƒì„±
â”œâ”€â”€ run-all-scenarios.sh           # ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
â”œâ”€â”€ quick-test.sh                   # ê°œë³„ ì‹œë‚˜ë¦¬ì˜¤ ë¹ ë¥¸ ì‹¤í–‰
â””â”€â”€ README.md                       # ì´ íŒŒì¼
```

## ğŸ” ì‹œë‚˜ë¦¬ì˜¤ë³„ ìƒì„¸ ì„¤ëª…

### ğŸ”¥ ì‹œë‚˜ë¦¬ì˜¤ 1: íƒ€ì„ì•„ì›ƒ (timeout)
**ìƒí™©**: Apache ProxyTimeout(25ì´ˆ) < Backend ì‘ë‹µì‹œê°„(30-40ì´ˆ)

```bash
cd scenarios/timeout
docker-compose up -d
curl -w "Time: %{time_total}s, HTTP: %{http_code}\n" -m 35 http://localhost/slow
# ì˜ˆìƒ ê²°ê³¼: Time: 25.012s, HTTP: 502
```

**ì‹¤ì œ ì‚¬ë¡€**: ë³µì¡í•œ DB ì¿¼ë¦¬, ëŒ€ìš©ëŸ‰ íŒŒì¼ ì²˜ë¦¬, ì™¸ë¶€ API í˜¸ì¶œ ì§€ì—°

### ğŸŒ ì‹œë‚˜ë¦¬ì˜¤ 2: DNS ì‹¤íŒ¨ (dns-failure)
**ìƒí™©**: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í˜¸ìŠ¤íŠ¸ëª…/ë„ë©”ì¸ìœ¼ë¡œ í”„ë¡ì‹œ ì‹œë„

```bash
cd scenarios/dns-failure
docker-compose up -d
curl -w "Time: %{time_total}s, HTTP: %{http_code}\n" http://localhost/dns-fail-host
# ì˜ˆìƒ ê²°ê³¼: Time: 0.001s, HTTP: 502 (ì¦‰ì‹œ ì‹¤íŒ¨)
```

**ì‹¤ì œ ì‚¬ë¡€**: ECS ì„œë¹„ìŠ¤ëª… ì˜¤íƒ€, Private DNS Zone ì„¤ì • ëˆ„ë½, í™˜ê²½ë³„ ì„¤ì • ì°¨ì´

### â° ì‹œë‚˜ë¦¬ì˜¤ 3: DNS ì§€ì—° (dns-delay)
**ìƒí™©**: ì„œë¹„ìŠ¤ ì‹œì‘ ì§€ì—°ìœ¼ë¡œ ì¸í•œ DNS í•´ì„ ë¬¸ì œ

```bash
cd scenarios/dns-delay
docker-compose up -d
sleep 45  # ë°±ì—”ë“œ ì‹œì‘ ëŒ€ê¸°
curl -w "Time: %{time_total}s, HTTP: %{http_code}\n" http://localhost/dns-slow
# ì˜ˆìƒ ê²°ê³¼: ì´ˆê¸° ì‹¤íŒ¨ â†’ ë‚˜ì¤‘ ì„±ê³µ
```

**ì‹¤ì œ ì‚¬ë¡€**: ECS ìŠ¤ì¼€ì¼ì—…, Kubernetes Pod ì¬ì‹œì‘, ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì§€ì—°

### ğŸ”„ ì‹œë‚˜ë¦¬ì˜¤ 4: ê°„í—ì  DNS ë¬¸ì œ (dns-intermittent)
**ìƒí™©**: ì„œë¹„ìŠ¤ ë¶ˆì•ˆì •ìœ¼ë¡œ ì¸í•œ ë¬´ì‘ìœ„ ì„±ê³µ/ì‹¤íŒ¨

```bash
cd scenarios/dns-intermittent
docker-compose up -d
# 15íšŒ ì—°ì† í…ŒìŠ¤íŠ¸ë¡œ íŒ¨í„´ í™•ì¸
for i in {1..15}; do curl http://localhost/intermittent; sleep 2; done
# ì˜ˆìƒ ê²°ê³¼: ì„±ê³µë¥  70% (ë¶ˆê·œì¹™í•œ íŒ¨í„´)
```

**ì‹¤ì œ ì‚¬ë¡€**: Auto Scaling, Spot Instance ì¤‘ë‹¨, Circuit Breaker, ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì¬ë°°í¬

## ğŸ“Š ì˜ˆìƒ ê²°ê³¼ ë¹„êµ

| ì‹œë‚˜ë¦¬ì˜¤ | ì—ëŸ¬ íƒ€ì… | ì‘ë‹µ ì‹œê°„ | HTTP ì½”ë“œ | ì¬í˜„ì„± | ì£¼ìš” ì›ì¸ |
|---------|----------|----------|-----------|--------|----------|
| **timeout** | í”„ë¡ì‹œ íƒ€ì„ì•„ì›ƒ | ~25ì´ˆ | 502 | 100% | Apache ProxyTimeout |
| **dns-failure** | DNS í•´ì„ ì‹¤íŒ¨ | ~0.001ì´ˆ | 502 | 100% | ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í˜¸ìŠ¤íŠ¸ |
| **dns-delay** | DNS í•´ì„ ì§€ì—° | 10ì´ˆ â†’ 0.05ì´ˆ | 502 â†’ 200 | ì‹œê°„ ì˜ì¡´ì  | ì„œë¹„ìŠ¤ ì‹œì‘ ì§€ì—° |
| **dns-intermittent** | ì„œë¹„ìŠ¤ ë¶ˆì•ˆì • | 0.04ì´ˆ~15ì´ˆ | 200/502 í˜¼ì¬ | 30-70% | ì„œë¹„ìŠ¤ ë¶ˆì•ˆì • |

---
